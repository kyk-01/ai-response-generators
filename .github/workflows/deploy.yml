name: CI/CD Spring Boot Deploy

# 이 Workflow는 main 브랜치에 push 될 때 실행됩니다.
on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    # 이 job은 GitHub Actions에서 제공하는 최신 Ubuntu 환경에서 실행됩니다.
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v3
        # 현재 리포지토리 코드를 워크플로우 환경으로 가져옵니다.

      # 2️⃣ JDK 17 설치
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'       # 설치할 JDK 버전
          distribution: 'temurin'  # OpenJDK 배포판 (Temurin)

      # 3️⃣ mvnw 실행 권한 부여
      - name: Make mvnw executable
        run: chmod +x GPT/mvnw
        # Linux 환경에서 mvnw 스크립트가 실행 가능하도록 권한을 추가합니다.

      # 4️⃣ Maven 빌드
      - name: Build with Maven
        run: ./mvnw clean package -DskipTests
        working-directory: GPT

      # 5️⃣ 빌드된 jar 파일 서버로 전송
      - name: Copy jar to server
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.SERVER_IP }}                   # 서버 IP
          username: ${{ secrets.SERVER_USER }}            # 서버 접속 사용자
          key: ${{ secrets.SERVER_SSH_KEY }}              # SSH 키
          source: "GPT/target/GPT-0.0.1-SNAPSHOT.jar"     # 로컬에서 전송할 파일 경로
          target: "/home/ubuntu/GPT/ai-response-generators/GPT/" # 서버 경로

      # 6️⃣ 서버에서 서비스 재시작
      - name: Restart Service
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo systemctl stop image-service    # 기존 서비스 종료
            sudo systemctl start image-service   # 새 jar로 서비스 시작
